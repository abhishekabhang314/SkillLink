<!-- frontend/apply.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Jobs - SkillLink</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
        <i class="fas fa-sun"></i>
    </button>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <i class="fas fa-link"></i>
                    <span>SkillLink</span>
                </a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="jobs.html" class="nav-link">View Jobs</a>
                <a href="apply.html" class="nav-link active">Apply Jobs</a>
                <a href="employer.html" class="nav-link">Post Job</a>
                <button id="connectWallet" class="btn-primary">
                    <i class="fas fa-wallet"></i>
                    Connect Wallet
                </button>
            </div>
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="index.html">Home</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>Apply for Jobs</span>
                </div>
                <h1>Apply for Your Dream Job</h1>
                <p>Submit your application directly on the blockchain</p>
            </div>

            <div class="job-form-container">
                <div class="form-sidebar">
                    <div class="sidebar-card">
                        <h3><i class="fas fa-lightbulb"></i> Application Tips</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Upload your latest resume</li>
                            <li><i class="fas fa-check"></i> Include portfolio links</li>
                            <li><i class="fas fa-check"></i> Write a compelling cover letter</li>
                            <li><i class="fas fa-check"></i> Highlight relevant experience</li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-card">
                        <h3><i class="fas fa-shield-alt"></i> Blockchain Security</h3>
                        <ul>
                            <li><i class="fas fa-lock"></i> Secure application storage</li>
                            <li><i class="fas fa-eye"></i> Transparent process</li>
                            <li><i class="fas fa-handshake"></i> Direct employer contact</li>
                            <li><i class="fas fa-coins"></i> No application fees</li>
                        </ul>
                    </div>

                    <div class="sidebar-card">
                        <h3><i class="fas fa-chart-line"></i> Your Stats</h3>
                        <ul>
                            <li><i class="fas fa-paper-plane"></i> <span id="userApplications">0</span> Applications Sent</li>
                            <li><i class="fas fa-eye"></i> <span id="userViews">0</span> Profile Views</li>
                            <li><i class="fas fa-star"></i> <span id="userRating">0</span> Rating</li>
                        </ul>
                    </div>
                </div>

                <div class="job-form-main">
                    <!-- Job Selection -->
                    <div class="form-card">
                        <div class="form-header">
                            <h2><i class="fas fa-search"></i> Select Job to Apply</h2>
                            <p>Choose from available job opportunities</p>
                        </div>

                        <div id="jobSelector" class="job-selector">
                            <div class="search-section">
                                <div class="search-bar">
                                    <div class="search-input-container">
                                        <i class="fas fa-search"></i>
                                        <input 
                                            type="text" 
                                            id="jobSearchInput" 
                                            placeholder="Search available jobs..."
                                            autocomplete="off"
                                        >
                                    </div>
                                    <button class="search-btn" onclick="searchAvailableJobs()">
                                        <i class="fas fa-search"></i>
                                        Search
                                    </button>
                                </div>
                            </div>

                            <div id="availableJobsContainer" class="available-jobs">
                                <!-- Available jobs will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Application Form -->
                    <div class="form-card" id="applicationFormCard" style="display: none;">
                        <div class="form-header">
                            <h2><i class="fas fa-user-edit"></i> Application Details</h2>
                            <p>Complete your application for the selected position</p>
                        </div>

                        <div id="selectedJobInfo" class="job-summary">
                            <!-- Selected job info will appear here -->
                        </div>

                        <form id="applicationForm" class="job-form">
                            <div class="form-group">
                                <label for="applicantName">
                                    <i class="fas fa-user"></i>
                                    Full Name *
                                </label>
                                <input 
                                    type="text" 
                                    id="applicantName" 
                                    name="applicantName" 
                                    placeholder="Enter your full name"
                                    required
                                    maxlength="100"
                                >
                            </div>

                            <div class="form-group">
                                <label for="applicantEmail">
                                    <i class="fas fa-envelope"></i>
                                    Email Address *
                                </label>
                                <input 
                                    type="email" 
                                    id="applicantEmail" 
                                    name="applicantEmail" 
                                    placeholder="your.email@example.com"
                                    required
                                >
                            </div>

                            <div class="form-group">
                                <label for="resumeLink">
                                    <i class="fas fa-link"></i>
                                    Resume/Portfolio Link *
                                </label>
                                <input 
                                    type="url" 
                                    id="resumeLink" 
                                    name="resumeLink" 
                                    placeholder="https://your-portfolio.com or https://drive.google.com/..."
                                    required
                                >
                                <div class="field-info">
                                    <span>Provide a link to your resume, LinkedIn, or portfolio</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="coverLetter">
                                    <i class="fas fa-file-alt"></i>
                                    Cover Letter *
                                </label>
                                <textarea 
                                    id="coverLetter" 
                                    name="coverLetter" 
                                    rows="8"
                                    placeholder="Tell us why you're perfect for this role. Highlight your relevant experience, skills, and enthusiasm for the position..."
                                    required
                                    maxlength="1500"
                                ></textarea>
                                <div class="field-info">
                                    <span>Make it personal and relevant to the job</span>
                                    <span class="char-count">0/1500</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="expectedSalary">
                                    <i class="fas fa-dollar-sign"></i>
                                    Expected Salary (USD)
                                </label>
                                <div class="salary-input">
                                    <span class="currency">$</span>
                                    <input 
                                        type="number" 
                                        id="expectedSalary" 
                                        name="expectedSalary" 
                                        placeholder="e.g. 80000"
                                        min="1"
                                        max="1000000"
                                    >
                                </div>
                                <div class="field-info">
                                    <span>Optional - helps employers understand your expectations</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="availabilityDate">
                                    <i class="fas fa-calendar"></i>
                                    Available Start Date
                                </label>
                                <input 
                                    type="date" 
                                    id="availabilityDate" 
                                    name="availabilityDate"
                                >
                                <div class="field-info">
                                    <span>When can you start working?</span>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="resetApplication()">
                                    <i class="fas fa-undo"></i>
                                    Reset Form
                                </button>
                                <button type="button" class="btn-outline" onclick="saveAsDraft()">
                                    <i class="fas fa-save"></i>
                                    Save Draft
                                </button>
                                <button type="submit" class="btn-primary btn-large" id="submitApplication">
                                    <i class="fas fa-paper-plane"></i>
                                    Submit Application
                                </button>
                            </div>

                            <div class="form-footer">
                                <p><i class="fas fa-info-circle"></i> 
                                Your application will be stored on the blockchain and sent directly to the employer. 
                                Make sure all information is accurate before submitting.</p>
                            </div>
                        </form>
                    </div>

                    <!-- Application Status -->
                    <div id="applicationStatus" class="transaction-status" style="display: none;">
                        <div class="status-content">
                            <div class="status-icon">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="status-text">
                                <h3>Submitting Application...</h3>
                                <p>Please confirm the transaction in your wallet and wait for blockchain confirmation.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <div id="applicationSuccess" class="success-message" style="display: none;">
                        <div class="success-content">
                            <div class="success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="success-text">
                                <h3>Application Submitted Successfully!</h3>
                                <p>Your application has been sent to the employer via blockchain.</p>
                                <div class="success-actions">
                                    <a href="jobs.html" class="btn-primary">Browse More Jobs</a>
                                    <button onclick="applyToAnother()" class="btn-secondary">Apply to Another Job</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="nav-logo">
                        <i class="fas fa-link"></i>
                        <span>SkillLink</span>
                    </div>
                    <p>The Future of Hiring</p>
                </div>
                <div class="footer-links">
                    <a href="jobs.html">Find Jobs</a>
                    <a href="employer.html">Post Jobs</a>
                    <a href="#about">About</a>
                    <a href="#contact">Contact</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 SkillLink. Built on Ethereum.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="app.js"></script>
    <script>
        let availableJobs = [];
        let selectedJobId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableJobs();
            setupApplicationEventListeners();
            loadUserStats();
        });

        function setupApplicationEventListeners() {
            // Cover letter character count
            document.getElementById('coverLetter').addEventListener('input', function() {
                updateCharCount('coverLetter', 1500);
            });

            // Job search
            document.getElementById('jobSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAvailableJobs();
                }
            });

            // Application form submission
            document.getElementById('applicationForm').addEventListener('submit', handleApplicationSubmission);
        }

        function updateCharCount(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const charCount = field.parentElement.querySelector('.char-count');
            const currentLength = field.value.length;
            charCount.textContent = `${currentLength}/${maxLength}`;
            
            if (currentLength > maxLength * 0.9) {
                charCount.style.color = 'var(--error-color)';
            } else {
                charCount.style.color = 'var(--text-secondary)';
            }
        }

        async function loadAvailableJobs() {
            try {
                // Load jobs from blockchain (you can integrate this with your existing loadJobs function)
                if (window.loadJobs) {
                    await window.loadJobs();
                    availableJobs = window.jobsData ? window.jobsData.filter(job => job.isActive) : [];
                } else {
                    // Mock data for demonstration
                    availableJobs = [
                        {
                            id: 1,
                            title: "Senior Frontend Developer",
                            description: "We're looking for an experienced frontend developer to join our team...",
                            salary: 95000,
                            employer: "0x1234...5678",
                            timestamp: Math.floor(Date.now() / 1000),
                            isActive: true,
                            applicantCount: 5
                        },
                        {
                            id: 2,
                            title: "Blockchain Developer",
                            description: "Join our team to build the next generation of DeFi applications...",
                            salary: 120000,
                            employer: "0x9876...4321",
                            timestamp: Math.floor(Date.now() / 1000) - 86400,
                            isActive: true,
                            applicantCount: 12
                        }
                    ];
                }
                renderAvailableJobs();
            } catch (error) {
                console.error('Error loading jobs:', error);
                showEmptyJobState();
            }
        }

        function renderAvailableJobs() {
            const container = document.getElementById('availableJobsContainer');
            
            if (availableJobs.length === 0) {
                showEmptyJobState();
                return;
            }

            container.innerHTML = availableJobs.map(job => `
                <div class="job-selection-card ${selectedJobId === job.id ? 'selected' : ''}" 
                     onclick="selectJob(${job.id})">
                    <div class="job-header">
                        <div class="job-title-section">
                            <h4 class="job-title">${job.title}</h4>
                            <div class="job-meta">
                                <span class="salary">
                                    <i class="fas fa-dollar-sign"></i>
                                    ${Number(job.salary).toLocaleString()}/year
                                </span>
                                <span class="posted-date">
                                    <i class="fas fa-clock"></i>
                                    ${formatDate(job.timestamp)}
                                </span>
                            </div>
                        </div>
                        <div class="job-select-indicator">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="job-description">
                        <p>${truncateText(job.description, 100)}</p>
                    </div>
                    <div class="job-info">
                        <span class="applicants">
                            <i class="fas fa-users"></i>
                            ${job.applicantCount} applicant${job.applicantCount !== 1 ? 's' : ''}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function showEmptyJobState() {
            document.getElementById('availableJobsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <h3>No Active Jobs Available</h3>
                    <p>There are currently no active job postings. Check back later or encourage employers to post new opportunities.</p>
                    <div class="empty-actions">
                        <a href="employer.html" class="btn-primary">
                            <i class="fas fa-plus"></i>
                            Post a Job
                        </a>
                        <button onclick="loadAvailableJobs()" class="btn-secondary">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            `;
        }

        function selectJob(jobId) {
            selectedJobId = jobId;
            const selectedJob = availableJobs.find(job => job.id === jobId);
            
            // Update UI to show selected job
            document.querySelectorAll('.job-selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[onclick="selectJob(${jobId})"]`).classList.add('selected');

            // Show selected job info
            document.getElementById('selectedJobInfo').innerHTML = `
                <h4>${selectedJob.title}</h4>
                <p class="modal-salary">$${Number(selectedJob.salary).toLocaleString()}/year</p>
                <p class="modal-employer">Employer: ${formatAddress(selectedJob.employer)}</p>
                <p class="job-desc">${selectedJob.description}</p>
            `;

            // Show application form
            document.getElementById('applicationFormCard').style.display = 'block';
            
            // Smooth scroll to application form
            document.getElementById('applicationFormCard').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function searchAvailableJobs() {
            const searchTerm = document.getElementById('jobSearchInput').value.toLowerCase();
            const filteredJobs = availableJobs.filter(job => 
                job.title.toLowerCase().includes(searchTerm) || 
                job.description.toLowerCase().includes(searchTerm)
            );
            
            // Temporarily update the display
            const container = document.getElementById('availableJobsContainer');
            if (filteredJobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>No Jobs Match Your Search</h3>
                        <p>Try different keywords or clear your search to see all jobs.</p>
                        <button onclick="clearJobSearch()" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Clear Search
                        </button>
                    </div>
                `;
            } else {
                availableJobs = filteredJobs;
                renderAvailableJobs();
            }
        }

        function clearJobSearch() {
            document.getElementById('jobSearchInput').value = '';
            loadAvailableJobs();
        }

        async function handleApplicationSubmission(e) {
            e.preventDefault();
            
            if (!selectedJobId) {
                alert('Please select a job to apply for');
                return;
            }

            // Validate form
            const form = document.getElementById('applicationForm');
            if (!validateApplicationForm(form)) {
                return;
            }

            const formData = new FormData(form);
            const applicationData = {
                jobId: selectedJobId,
                name: formData.get('applicantName'),
                email: formData.get('applicantEmail'),
                resumeLink: formData.get('resumeLink'),
                coverLetter: formData.get('coverLetter'),
                expectedSalary: formData.get('expectedSalary') || 0,
                availabilityDate: formData.get('availabilityDate') || ''
            };

            try {
                // Show loading state
                document.getElementById('applicationStatus').style.display = 'block';
                document.getElementById('submitApplication').disabled = true;

                // Submit application (integrate with your blockchain function)
                if (window.applyToJob) {
                    await window.applyToJob(selectedJobId, applicationData.resumeLink);
                } else {
                    // Simulate transaction
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }

                // Show success
                document.getElementById('applicationStatus').style.display = 'none';
                document.getElementById('applicationSuccess').style.display = 'block';
                
                // Update user stats
                updateUserStats();

            } catch (error) {
                console.error('Application submission error:', error);
                alert('Failed to submit application. Please try again.');
                document.getElementById('applicationStatus').style.display = 'none';
                document.getElementById('submitApplication').disabled = false;
            }
        }

        function validateApplicationForm(form) {
            const inputs = form.querySelectorAll('input[required], textarea[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value === '') {
                    input.style.borderColor = 'var(--error-color)';
                    isValid = false;
                } else {
                    input.style.borderColor = 'var(--success-color)';
                }
            });
            
            return isValid;
        }

        function resetApplication() {
            document.getElementById('applicationForm').reset();
            document.getElementById('applicationFormCard').style.display = 'none';
            document.getElementById('applicationStatus').style.display = 'none';
            document.getElementById('applicationSuccess').style.display = 'none';
            selectedJobId = null;
            
            // Clear selection
            document.querySelectorAll('.job-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Reset character count
            document.querySelector('.char-count').textContent = '0/1500';
        }

        function applyToAnother() {
            resetApplication();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function saveAsDraft() {
            const formData = new FormData(document.getElementById('applicationForm'));
            const draftData = {
                jobId: selectedJobId,
                name: formData.get('applicantName'),
                email: formData.get('applicantEmail'),
                resumeLink: formData.get('resumeLink'),
                coverLetter: formData.get('coverLetter'),
                expectedSalary: formData.get('expectedSalary'),
                availabilityDate: formData.get('availabilityDate'),
                savedAt: new Date().toISOString()
            };

            // Save to local storage for now (in a real app, you might save to a database)
            localStorage.setItem('applicationDraft', JSON.stringify(draftData));
            
            // Show notification
            if (window.showNotification) {
                window.showNotification('Application draft saved successfully!', 'success', 3000);
            } else {
                alert('Draft saved successfully!');
            }
        }

        function loadUserStats() {
            // Mock user stats - in real app, load from blockchain or database
            document.getElementById('userApplications').textContent = '3';
            document.getElementById('userViews').textContent = '24';
            document.getElementById('userRating').textContent = '4.8';
        }

        function updateUserStats() {
            const current = parseInt(document.getElementById('userApplications').textContent);
            document.getElementById('userApplications').textContent = current + 1;
        }

        // Utility functions
        function formatDate(timestamp) {
            const date = new Date(Number(timestamp) * 1000);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString();
        }

        function formatAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.slice(0, maxLength) + '...';
        }
    </script>

    <style>
        /* Additional styles for Apply Jobs page */
        .job-selection-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .job-selection-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .job-selection-card.selected {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: var(--shadow-lg);
        }

        [data-theme="dark"] .job-selection-card.selected {
            background: rgba(96, 165, 250, 0.1);
            box-shadow: var(--shadow-lg), var(--glow-primary);
        }

        .job-select-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: var(--text-muted);
            font-size: 1.2rem;
            opacity: 0;
            transition: var(--transition);
        }

        .job-selection-card.selected .job-select-indicator {
            opacity: 1;
            color: var(--primary-color);
        }

        [data-theme="dark"] .job-selection-card.selected .job-select-indicator {
            color: var(--primary-color);
            text-shadow: var(--glow-primary);
        }

        .available-jobs {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .job-desc {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Enhanced form styling for apply page */
        #applicationFormCard {
            margin-top: 2rem;
            border: 2px solid var(--primary-color);
            background: linear-gradient(145deg, var(--bg-primary), rgba(37, 99, 235, 0.02));
        }

        [data-theme="dark"] #applicationFormCard {
            border: 2px solid var(--primary-color);
            background: linear-gradient(145deg, var(--bg-primary), rgba(96, 165, 250, 0.05));
            box-shadow: var(--shadow-lg), var(--card-glow);
        }

        /* Scroll styling for available jobs */
        .available-jobs::-webkit-scrollbar {
            width: 6px;
        }

        .available-jobs::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .available-jobs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .available-jobs::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        [data-theme="dark"] .available-jobs::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
            box-shadow: var(--glow-primary);
        }
    </style>
</body>
</html>